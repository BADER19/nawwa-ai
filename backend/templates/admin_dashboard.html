<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Nawwa Admin Dashboard</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: #f5f5f5;
            padding: 20px;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
        }
        h1 {
            color: #333;
            margin-bottom: 30px;
        }
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        .stat-card {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .stat-card h3 {
            color: #666;
            font-size: 14px;
            margin-bottom: 10px;
        }
        .stat-card .value {
            font-size: 32px;
            font-weight: bold;
            color: #1a73e8;
        }
        .users-table {
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            overflow: hidden;
        }
        .users-table h2 {
            padding: 20px;
            border-bottom: 1px solid #eee;
        }
        table {
            width: 100%;
            border-collapse: collapse;
        }
        th, td {
            padding: 12px 20px;
            text-align: left;
            border-bottom: 1px solid #eee;
        }
        th {
            background: #f8f9fa;
            font-weight: 600;
            color: #666;
        }
        .tier-badge {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: 600;
        }
        .tier-FREE {
            background: #e3f2fd;
            color: #1976d2;
        }
        .tier-PRO {
            background: #fce4ec;
            color: #c2185b;
        }
        .admin-badge {
            background: #fff3e0;
            color: #f57c00;
        }
        .login-form {
            max-width: 400px;
            margin: 100px auto;
            background: white;
            padding: 30px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .login-form h2 {
            margin-bottom: 20px;
        }
        .login-form input {
            width: 100%;
            padding: 12px;
            margin-bottom: 15px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
        }
        .login-form button {
            width: 100%;
            padding: 12px;
            background: #1a73e8;
            color: white;
            border: none;
            border-radius: 4px;
            font-size: 14px;
            cursor: pointer;
        }
        .login-form button:hover {
            background: #1557b0;
        }
        .error {
            color: #d32f2f;
            margin-bottom: 15px;
        }
        .refresh-btn {
            padding: 10px 20px;
            background: #1a73e8;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            margin-bottom: 20px;
        }
        .refresh-btn:hover {
            background: #1557b0;
        }
    </style>
</head>
<body>
    <div id="loginForm" class="login-form">
        <h2>Admin Login</h2>
        <div id="loginError" class="error" style="display:none;"></div>
        <input type="email" id="email" placeholder="Email" />
        <input type="password" id="password" placeholder="Password" />
        <button onclick="login()">Login</button>
    </div>

    <div id="dashboard" class="container" style="display:none;">
        <h1>ðŸ“Š Nawwa Admin Dashboard</h1>
        <button class="refresh-btn" onclick="loadDashboard()">ðŸ”„ Refresh</button>

        <div class="stats-grid">
            <div class="stat-card">
                <h3>Total Users</h3>
                <div class="value" id="totalUsers">-</div>
            </div>
            <div class="stat-card">
                <h3>Today</h3>
                <div class="value" id="todaySignups">-</div>
            </div>
            <div class="stat-card">
                <h3>This Week</h3>
                <div class="value" id="weekSignups">-</div>
            </div>
            <div class="stat-card">
                <h3>PRO Users</h3>
                <div class="value" id="proUsers">-</div>
            </div>
        </div>

        <div class="users-table">
            <h2>Recent Users</h2>
            <table>
                <thead>
                    <tr>
                        <th>Email</th>
                        <th>Username</th>
                        <th>Tier</th>
                        <th>Usage</th>
                        <th>Joined</th>
                    </tr>
                </thead>
                <tbody id="usersTableBody">
                    <tr><td colspan="5">Loading...</td></tr>
                </tbody>
            </table>
        </div>
    </div>

    <script>
        const API_BASE = window.location.origin;
        let token = localStorage.getItem('admin_token');

        if (token) {
            document.getElementById('loginForm').style.display = 'none';
            document.getElementById('dashboard').style.display = 'block';
            loadDashboard();
        }

        async function login() {
            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;
            const errorDiv = document.getElementById('loginError');

            try {
                const response = await fetch(`${API_BASE}/auth/login`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ email, password })
                });

                const data = await response.json();

                if (response.ok) {
                    token = data.access_token;
                    localStorage.setItem('admin_token', token);
                    document.getElementById('loginForm').style.display = 'none';
                    document.getElementById('dashboard').style.display = 'block';
                    loadDashboard();
                } else {
                    errorDiv.textContent = 'Invalid credentials or not an admin';
                    errorDiv.style.display = 'block';
                }
            } catch (error) {
                errorDiv.textContent = 'Login failed: ' + error.message;
                errorDiv.style.display = 'block';
            }
        }

        async function loadDashboard() {
            try {
                // Load users
                const usersResponse = await fetch(`${API_BASE}/admin/users?limit=100`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });

                if (usersResponse.status === 403) {
                    alert('You are not an admin. Please contact support.');
                    logout();
                    return;
                }

                const usersData = await usersResponse.json();
                const users = usersData.users || [];

                // Calculate stats
                const totalUsers = users.length;
                const proUsers = users.filter(u => u.subscription_tier === 'PRO').length;

                const today = new Date();
                today.setHours(0, 0, 0, 0);
                const todaySignups = users.filter(u => new Date(u.created_at) >= today).length;

                const weekAgo = new Date();
                weekAgo.setDate(weekAgo.getDate() - 7);
                const weekSignups = users.filter(u => new Date(u.created_at) >= weekAgo).length;

                // Update stats
                document.getElementById('totalUsers').textContent = totalUsers;
                document.getElementById('todaySignups').textContent = todaySignups;
                document.getElementById('weekSignups').textContent = weekSignups;
                document.getElementById('proUsers').textContent = proUsers;

                // Update table
                const tbody = document.getElementById('usersTableBody');
                tbody.innerHTML = users.slice(0, 20).map(user => {
                    const joinedDate = new Date(user.created_at);
                    const daysAgo = Math.floor((new Date() - joinedDate) / (1000 * 60 * 60 * 24));
                    const timeAgo = daysAgo === 0 ? 'Today' : daysAgo === 1 ? 'Yesterday' : `${daysAgo}d ago`;

                    return `
                        <tr>
                            <td>${user.email}</td>
                            <td>${user.username || '-'}</td>
                            <td>
                                <span class="tier-badge tier-${user.subscription_tier}">${user.subscription_tier}</span>
                                ${user.is_admin ? '<span class="tier-badge admin-badge">ADMIN</span>' : ''}
                            </td>
                            <td>${user.usage_count}</td>
                            <td>${timeAgo}</td>
                        </tr>
                    `;
                }).join('');

            } catch (error) {
                console.error('Failed to load dashboard:', error);
                alert('Failed to load dashboard. Check console for details.');
            }
        }

        function logout() {
            localStorage.removeItem('admin_token');
            location.reload();
        }

        // Auto-refresh every 30 seconds
        setInterval(loadDashboard, 30000);
    </script>
</body>
</html>